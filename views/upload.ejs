<!DOCTYPE html>
<html lang="en">

<head>
  <title>アップロード</title>
  <%- include('common/head') %>
  <script src="upload/javascripts/upload.js"></script>
</head>

<body>
  <%- include('common/navbar', {logout: true}) %>
    <main class="container">
      <h3 class="header">Unity WebGLゲームを投稿する</h3>
      <form action="/upload/webgl" method="POST" enctype="multipart/form-data">
        <div class="row card-panel">
          <div class="input-field">
            <input id="creator_name" type="text" class="validate" name="creator_id" pattern="^[0-9a-z\-]+$" required aria-required />
            <label for="creator_name">作者ID</label>
            <span class="helper-text" data-error="数字・アルファベット小文字・ハイフンのみで入力してください" data-success="問題なし"></span>
          </div>
          <div class="input-field">
            <input id="game_name" type="text" class="validate" name="game_id" pattern="^[0-9a-z\-]+$" required aria-required />
            <label for="game_name">ゲームID</label>
            <span class="helper-text" data-error="数字・アルファベット小文字・ハイフンのみで入力してください" data-success="問題なし"></span>
          </div>
          <p>
            <label>
              <input type="checkbox" class="filled-in" name="overwrites_existing" />
              <span>上書きする</span>
            </label>
          </p>
        </div>
        <div class="row card-panel">
          <blockquote class="message-hidden-folder-files" style="display: none;">
            隠しフォルダ(.gitなど)内のフォルダはアップロードされません。
          </blockquote>
          <div class="input-field file-field-frame">
            <div class="placeholder">
              <h6>
                ここにフォルダをドロップ
              </h6>
              <div>または</div>
              <h6>
                クリックしてフォルダを選択
              </h6>
            </div>
            <input class="file-path validate" type="file" name="game" webkitdirectory required aria-required />
          </div>
          <div class="divider"></div>
          <ul class="collapsible">
            <li>
              <div class="collapsible-header">
                <i class="material-icons">keyboard_arrow_down</i>
                <span class="file-count">0個のファイル</span>
              </div>
              <div class="collapsible-body">
                <div class="file-list-header">http://localhost:3000/game/<span class="creator_id">(作者ID)</span>/<span
                    class="game_id">(ゲームID)</span>/webgl/</div>
                <div class="file-list"></div>
              </div>
            </li>
          </ul>
        </div>
        <div class="row center">
          <button type="submit" class="btn uploadButton">アップロードする</button>
        </div>
      </form>
      <div class="uploadingIndicator" style="display: none;">
        <div style="margin: auto;">
          <div class="preloader-wrapper big active">
            <div class="spinner-layer spinner-green-only">
              <div class="circle-clipper left">
                <div class="circle"></div>
              </div><div class="gap-patch">
                <div class="circle"></div>
              </div><div class="circle-clipper right">
                <div class="circle"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="result-dialog" class="modal">
        <div class="modal-content">
        </div>
        <div class="modal-footer">
          <a class="modal-close waves-effect waves-green btn-flat">閉じる</a>
        </div>
      </div>    
    </main>
    <script>
      //Materializeのロード
      document.addEventListener('DOMContentLoaded', function () {
        M.Collapsible.init(document.querySelector('.collapsible'), {
          onOpenStart: (elm) => {
            elm.querySelector('.collapsible-header>.material-icons').innerHTML = 'keyboard_arrow_up';
          },
          onCloseStart: (elm) => {
            elm.querySelector('.collapsible-header>.material-icons').innerHTML = 'keyboard_arrow_down';
          },
        });
        M.Modal.init(document.querySelector("#result-dialog"), {});
      });
    </script>
    <script>
      //ドラッグ&ドロップ時のUI変化
      {
        const filesField = document.querySelector('input[name="game"]');
        const fileFieldFrame = document.querySelector(".input-field.file-field-frame");
        filesField.addEventListener("dragenter", (event) => {
          fileFieldFrame.classList.add("drag");
        });
        filesField.addEventListener("dragleave", (event) => {
          fileFieldFrame.classList.remove("drag");
        });
        filesField.addEventListener("drop", (event) => {
          fileFieldFrame.classList.remove("drag");
        });

      }
    </script>
    <script>
      {
        //ドロップ時の動作
        const filesField = document.querySelector('input[name="game"]');
        const fileList = document.querySelector('.file-list');
        filesField.addEventListener('change', (event) => onFilesDropped());
        function onFilesDropped() {
          fileList.innerHTML = '';
          document.querySelector('.message-hidden-folder-files').style.display = 'none';
          const filePaths = [];
          const dt = new DataTransfer();
          Array.from(filesField.files).filter((file) => {//隠しフォルダ内のファイルを除去
            const directories = file.webkitRelativePath.split('/');
            return directories.find((dir) => dir.startsWith('.')) === undefined;
          }).forEach((file) => {
            filePaths.push(file.webkitRelativePath.replace(/^[^\/]+\//, ''));
            dt.items.add(file);
          });
          const fileCountBefore = filesField.files.length;
          const fileCountAfter = dt.files.length;
          if (fileCountBefore > fileCountAfter) {
            document.querySelector('.message-hidden-folder-files').style.display = 'block';
          }
          filesField.files = dt.files;
          filePaths.sort();
          filePaths.forEach((path) => {
            let parent = fileList;
            path.split('/').forEach((section) => {
              let p_ul = Array.from(parent.childNodes).find((node) => node.tagName === 'UL');
              if (!p_ul) {
                p_ul = document.createElement('ul');
                parent.appendChild(p_ul);
              }
              let li = Array.from(p_ul.childNodes).find((node) => node.tagName === 'LI' && node.getAttribute('name') == section);
              if (!li) {
                li = document.createElement('li');
                li.innerHTML = section;
                li.setAttribute('name', section);
                p_ul.appendChild(li);
              }
              parent = li;
            });
          });
          const fileCount = document.querySelector('.file-count');
          fileCount.innerHTML = `${dt.items.length}個のファイル`;
        }
      }
    </script>
    <script>
      {
        //アップロード先URLの同期
        const creatorIdInput = document.querySelector('input[name="creator_id"]');
        creatorIdInput.addEventListener('change', (ev) => {
          let creatorId = creatorIdInput.value;
          if (creatorId.length == 0) {
            creatorId = '(作者ID)';
          }
          document.querySelector('.file-list-header>.creator_id').innerHTML = creatorId;
        });
        const gameIdInput = document.querySelector('input[name="game_id"]');
        gameIdInput.addEventListener('change', (ev) => {
          let gameId = gameIdInput.value;
          if (gameId.length == 0) {
            gameId = '(ゲームID)';
          }
          document.querySelector('.file-list-header>.game_id').innerHTML = gameId;
        });
      }
    </script>
    <script>
      {
        const form = document.querySelector('form');
        const uploadButton = document.querySelector('.uploadButton');
        const uploadingIndicator = document.querySelector('.uploadingIndicator');
        form.addEventListener('submit', function (event) {
          event.preventDefault();
          uploadButton.classList.add('disabled');
          uploadingIndicator.style.display='flex'
          const data = new FormData(form);
          const request = new XMLHttpRequest();
          request.open('POST', '/upload/webgl', true);
          request.setRequestHeader('x-creator-id', document.querySelector('input[name="creator_id"]').value)
          request.setRequestHeader('x-game-id', document.querySelector('input[name="game_id"]').value)
          request.setRequestHeader('x-overwrites-existing', document.querySelector('input[name="overwrites_existing"]').checked)
          request.addEventListener('load', (ev)=>{            
            uploadButton.classList.remove('disabled');
            uploadingIndicator.style.display='none';

            let content = `<h4>${(request.status === 200) ? "アップロードに成功しました" : "アップロードに失敗しました"}</h4>`;
            if(request.status === 200){
              const path = JSON.parse(request.response).path?.replaceAll("\\", "/");
              if(path !== undefined){
                const url = `${location.origin}${path}`;
                content += `<p><a href="${url}">${url}</a>にアップロードしました。</p>`;
              }
            }else {
              content += request.response;
            }
            const dialog = document.querySelector("#result-dialog");
            dialog.querySelector('.modal-content').innerHTML = content;
            M.Modal.getInstance(dialog).open();
          })
          request.send(data);
          uploadButton.classList.add('disabled');
          uploadingIndicator.style.display='flex'
        });
      }
    </script>
    <%- include('common/footer') %>
      <%- include('common/scripts') %>
</body>

</html>